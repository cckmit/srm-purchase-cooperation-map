<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.srm.purchasecooperation.cux.infra.mapper.SinochemintlPoPlanLineMapper">

    <sql id="mappingChanges">
        SELECT spl.pr_line_id          poPlanLineId,
               spl.pr_header_id        poPlanHeaderId,
               spl.tenant_id           tenantId,
               sph.pr_status_code      status,
               spl.attribute_bigint14  spellDocProvince,
               spl.needed_date         needDate,
               spl.attribute_longtext9 planSharedProvince,
               spl.company_id          provinceCompanyId,
               hc.company_name         provinceCompany,
               spl.product_name        productName,
               spl.attribute_varchar24 specification,
               spl.supplier_id         initialSupplierId,
               spl.supplier_name       initialSupplier,
               spl.attribute_varchar39 endSupplier,
               spl.attribute_decimal3  endPrice,
               spl.unit_price          factoryPrice,
               spl.attribute_varchar25 deliveryAddress,
               spl.item_id             materialId,
               spl.item_code           materialCoding,
               sic.category_name       materialClass,
               spl.quantity            requiredQuantity,
               spl.uom_id              uomId,
               su.uom_name             unitName,
               spl.currency_code       currencyId,
               sc.currency_name        currencyName,
               spl.attribute_varchar38 freightSupplier,
               spl.line_freight        freightPrice,
               spl.attribute_varchar39 priceTerms,
               spl.remark              remark,
               spl.tax_id              taxId,
               st.description          taxType,
               spl.tax_rate            taxRate,
               spl.pr_requested_name   applicant,
               spl.line_num            serialNum,
               spl.display_line_num    displayLineNum,
               spl.attribute_bigint15  sharedProvinceId,
               spl.attribute_decimal4  totalPurchasePrice,
               spl.attribute_decimal5  totalPurchaseFinalPrice,
               spl.attachment_uuid     appendixId
        FROM sprm_pr_header sph
                 LEFT JOIN sprm_pr_line spl ON spl.pr_header_id = sph.pr_header_id
                 LEFT JOIN smdm_item si ON si.item_id = spl.item_id
                 LEFT JOIN smdm_item_category sic ON sic.category_code = si.attribute_varchar5
                 LEFT JOIN smdm_tax st ON spl.tax_id = st.tax_id
                 LEFT JOIN smdm_uom su ON su.uom_id = spl.uom_id
                 LEFT JOIN smdm_currency sc ON sc.currency_id = spl.currency_code
                 LEFT JOIN hpfm_company hc ON hc.company_id = spl.company_id
    </sql>

    <!--    保存行表-->
    <insert id="setOne">
        INSERT INTO sprm_pr_line (pr_header_id,
                                  tenant_id,
                                  attribute_bigint14,
                                  needed_date,
                                  attribute_longtext9,
                                  product_name,
                                  attribute_varchar24,
                                  supplier_id,
                                  supplier_name,
                                  unit_price,
                                  attribute_varchar25,
                                  item_id,
                                  item_code,
                                  quantity,
                                  uom_id,
                                  currency_code,
                                  attribute_varchar38,
                                  line_freight,
                                  attribute_varchar39,
                                  remark,
                                  tax_id,
                                  tax_rate,
                                  pr_requested_name,
                                  line_num,
                                  display_line_num,
                                  company_id,
                                  attribute_bigint15,
                                  attribute_decimal4,
                                  attribute_decimal5,
                                  attachment_uuid)
            VALUE (#{poPlanHeaderId},
            #{tenantId},
            #{spellDocProvince},
            #{needDate},
            #{planSharedProvince},
            #{productName},
            #{specification},
            #{initialSupplierId},
            #{initialSupplier},
            #{factoryPrice},
            #{deliveryAddress},
            #{materialId},
            #{materialCoding},
            #{requiredQuantity},
            #{uomId},
            #{currencyId},
            #{freightSupplier},
            #{freightPrice},
            #{priceTerms},
            #{remark},
            #{taxId},
            #{taxRate},
            #{applicant},
            #{serialNum},
            #{displayLineNum},
            #{provinceCompanyId},
            #{sharedProvinceId},
            #{totalPurchasePrice},
            #{totalPurchaseFinalPrice},
            #{appendixId}
            )
    </insert>

    <!--    根据行表id修改-->
    <update id="updateByKey">
        update sprm_pr_line
        set attribute_bigint14  = #{spellDocProvince},
            needed_date         = #{needDate},
            attribute_longtext9 = #{planSharedProvince},
            company_id          = #{provinceCompanyId},
            product_name        = #{productName},
            attribute_varchar24 = #{specification},
            supplier_id         = #{initialSupplierId},
            supplier_name       = #{initialSupplier},
            attribute_varchar39 = #{endSupplier},
            attribute_decimal3  = #{endPrice},
            unit_price          = #{factoryPrice},
            attribute_varchar25 = #{deliveryAddress},
            item_id             = #{materialId},
            item_code           = #{materialCoding},
            quantity            = #{requiredQuantity},
            uom_id              = #{uomId},
            currency_code       = #{currencyId},
            attribute_varchar38 = #{freightSupplier},
            line_freight        = #{freightPrice},
            attribute_varchar39 = #{priceTerms},
            remark              = #{remark},
            tax_id              = #{taxId},
            tax_rate            = #{taxRate},
            pr_requested_name   = #{applicant},
            attribute_bigint15  = #{sharedProvinceId},
            attribute_decimal4  = #{totalPurchasePrice},
            attribute_decimal5  = #{totalPurchaseFinalPrice},
            attachment_uuid     = #{appendixId}
        where pr_line_id = #{poPlanLineId}
    </update>

    <!--    根据头表id删除-->
    <delete id="deleteByKey">
        DELETE
        FROM sprm_pr_line
        WHERE pr_line_id = #{poPlanLineId}
    </delete>

    <!--    根据行表id查询-->
    <select id="selectByKey" resultType="org.srm.purchasecooperation.cux.api.dto.SinochemintlPoPlanLineDTO">
        <include refid="mappingChanges"/>
        WHERE spl.pr_line_id = #{poPlanLineId}
    </select>

    <!--    根据头表id查询-->
    <select id="selectByHeaderId" resultType="org.srm.purchasecooperation.cux.api.dto.SinochemintlPoPlanLineDTO">
        <include refid="mappingChanges"/>
        WHERE sph.tenant_id = #{organizationId}
        and sph.pr_header_id = #{poPlanHeaderId}
        GROUP BY display_line_num
    </select>

    <!--    获取共享计划省区-->
    <select id="getPlanSharedProvince" resultType="java.lang.String">
        SELECT company_name FROM hpfm_company
        WHERE company_id in
        <foreach collection="list" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>

    <!--    获取当前排序-->
    <select id="getSerialNum" resultType="java.lang.Integer">
        SELECT line_num
        FROM sprm_pr_line
        where pr_header_id = #{poPlanHeaderId}
        GROUP BY line_num DESC
        LIMIT 1
    </select>
    <select id="getDisplayLineNum" resultType="java.lang.Integer">
        SELECT display_line_num
        FROM sprm_pr_line
        where pr_header_id = #{poPlanHeaderId}
            and attribute_bigint15 = #{sharedProvinceId}
           OR pr_line_id = #{sharedProvinceId}
        GROUP BY display_line_num DESC
        LIMIT 1
    </select>

    <!--    共享计划省区校验-->
    <select id="sharedProvinceVerify" resultType="org.srm.purchasecooperation.cux.api.dto.SinochemintlPoPlanLineDTO">
        SELECT company_id provinceCompanyId,
        company_name provinceCompany
        FROM hpfm_company
        WHERE company_name in
        <foreach collection="list" item="name" open="(" close=")" separator=",">
            #{name}
        </foreach>
    </select>

</mapper>