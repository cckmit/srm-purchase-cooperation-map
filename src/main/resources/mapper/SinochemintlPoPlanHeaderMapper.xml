<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.srm.purchasecooperation.cux.infra.mapper.SinochemintlPoPlanHeaderMapper">

    <sql id="mappingChanges">
        SELECT sph.pr_header_id        poPlanHeaderId,
               sph.tenant_id           tenantId,
               sph.title               title,
               sph.pr_status_code      status,
               sph.attribute_varchar23 planType,
               sph.pr_num              poPlanNumber,
               sph.requested_by        createId,
               sph.pr_requested_name   createName,
               sph.attribute_datetime1 deadline,
               sph.parent_unit_id      companyCode,
               sph.purchase_org_id     purchaseOrgCode,
               sph.purchase_agent_id   purchaseCode,
               sph.pr_source_platform  poSource,
               sph.pr_requested_name   applicant,
               sph.unit_id             departmentCode,
               sph.request_date        applicationDate,
               sph.original_currency   originalCurrency,
               sph.attribute_varchar24 planIllustrate,
               sph.creation_date       creationDate,
               sph.attribute_varchar22 businessCode,
               (SELECT SUM(unit_price) FROM sprm_pr_line WHERE pr_header_id = #{poPlanHeaderId})
                                       applicationSum
        FROM sprm_pr_header sph
                 LEFT JOIN sprm_pr_line spl ON spl.pr_header_id = sph.pr_header_id
    </sql>

    <!--    保存头表-->
    <insert id="setOne">
        INSERT INTO sprm_pr_header (tenant_id,
                                    title,
                                    pr_status_code,
                                    attribute_varchar23,
                                    pr_num,
                                    requested_by,
                                    pr_requested_name,
                                    attribute_datetime1,
                                    parent_unit_id,
                                    purchase_org_id,
                                    purchase_agent_id,
                                    pr_source_platform,
                                    pr_requested_name,
                                    unit_id,
                                    request_date,
                                    original_currency,
                                    attribute_varchar24,
                                    creation_date,
                                    display_pr_num,
                                    lot_num,
                                    attribute_varchar22)
            VALUE (#{tenantId},
            #{title},
            #{status},
            #{planType},
            #{poPlanNumber},
            #{createId},
            #{createName},
            #{deadline},
            #{companyCode},
            #{purchaseOrgCode},
            #{purchaseCode},
            #{poSource},
            #{applicant},
            #{departmentCode},
            #{applicationDate},
            #{originalCurrency},
            #{planIllustrate},
            #{creationDate},
            #{poPlanNumber},
            '0',
            #{businessCode}
            )
    </insert>

    <!--    根据头表id修改-->
    <update id="updateByKey">
        update sprm_pr_header
        set sph.title               = #{title},
            sph.pr_status_code      = #{status},
            sph.attribute_varchar23 = #{planType},
            sph.pr_num              = #{poPlanNumber},
            sph.requested_by        = #{createId},
            sph.pr_requested_name   = #{createName},
            sph.attribute_datetime1 = #{deadline},
            sph.parent_unit_id      = #{companyCode},
            sph.purchase_org_id     = #{purchaseOrgCode},
            sph.purchase_agent_id   = #{purchaseCode},
            sph.pr_source_platform  = #{poSource},
            sph.pr_requested_name   = #{applicant},
            sph.unit_id             = #{departmentCode},
            sph.request_date        = #{applicationDate},
            sph.original_currency   = #{originalCurrency},
            sph.attribute_varchar24 = #{planIllustrate},
            sph.creation_date       = #{creationDate},
            sph.attribute_varchar22 = #{businessCode}
        where pr_header_id = #{poPlanHeaderId}
    </update>

    <!--    根据头表id删除-->
    <delete id="deleteByKey">
        DELETE
        FROM sprm_pr_header
        WHERE pr_header_id = #{poPlanHeaderId}
    </delete>

    <!--    采购计划头表查询参数-->
    <select id="list" resultType="org.srm.purchasecooperation.cux.api.dto.SinochemintlPoPlanHeaderDTO">
        <include refid="mappingChanges"/>
        WHERE sph.tenant_id = #{tenantId}
        <if test="poPlanNumber != null and poPlanNumber != ''">
            <bind name="poPlanNumberLike" value="'%' + poPlanNumber + '%'"/>
            AND sph.pr_num like #{poPlanNumberLike}
        </if>
        <if test="title != null and title != ''">
            <bind name="titleLike" value="'%' + title + '%'"/>
            AND sph.title like #{titleLike}
        </if>
        <if test="status != null and status != ''">
            AND sph.attribute_varchar22 = #{status}
        </if>
    </select>

    <!--    根据头表id查询-->
    <select id="selectByKey" resultType="org.srm.purchasecooperation.cux.api.dto.SinochemintlPoPlanHeaderDTO">
        <include refid="mappingChanges"/>
        WHERE sph.pr_header_id = #{poPlanHeaderId}
    </select>

</mapper>